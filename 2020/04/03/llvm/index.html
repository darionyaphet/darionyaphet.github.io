<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="science &amp; art"><title>llvm | Hexo</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a></nav><div class="container post-meta"><div class="post-time">2020-04-03</div></div></div><div class="container post-header"><h1>llvm</h1></div><div class="container post-content"><p><code>LLVM</code> 这个名字源于 <code>Low Level Virtual Machine</code>，但并不限于创建一个虚拟机，它已经发展成当今炙手可热的编译器基础框架。所谓编译器，就是把人类可读的高级语言转化为机器码的组件。<code>LLVM</code>采用模块化思想，使得每一个编译单元彼此独立。</p>
<p><code>LLVM</code> 的设计目标是成为一系列的库。<code>LLVM</code> 代码有三种表示形式：内存编译器的IR，基于磁盘的Byte Code和汇编码。LLVM IR致力于成为一种足够底层的通用IR，基于静态单赋值，提供类型安全性，底层操作性和灵活性。</p>
<hr>
<p><strong>C 代码转化为LLVM汇编码</strong></p>
<blockquote>
<p>将C代码编译为LLVM IR的过程从词法分析开始——将C代码分解成token流，每个token可表示标识符、字面量、运算符等；token流会传递给语法分析器，语法分析器会在语言的CFG（上下文无关文法）的指导下将token流组织成抽象语法树；接下来会进行语义分析，检查语义正确性，然后生成IR。</p>
</blockquote>
<p>在<code>multiply.c</code> 中编写一段C代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">int mult() &#123;</span><br><span class="line">  int a =5;</span><br><span class="line">  int b = 3;</span><br><span class="line">  int c = a * b;</span><br><span class="line">  return c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用以下命令来将C代码转换成LLVM IR：</p>
<p><code>clang -emit-llvm -S multiply.c -o multiply.ll</code></p>
<p>生成如下的LLVM IR：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">; ModuleID = &apos;multiply.c&apos;</span><br><span class="line">target datalayout = &quot;e-p:64:64:64-i1:8:8-i8:8:8-i16:16:16-i32:32:32-i64:64:64-f32:32:32-f64:64:64-v64:64:64-v128:128:128-a0:0:64-s0:64:64-f80:128:128-n8:16:32:64-S128&quot;</span><br><span class="line">target triple = &quot;x86_64-redhat-linux-gnu&quot;</span><br><span class="line"></span><br><span class="line">; Function Attrs: nounwind uwtable</span><br><span class="line">define i32 @mult() #0 &#123;</span><br><span class="line">  %a = alloca i32, align 4</span><br><span class="line">  %b = alloca i32, align 4</span><br><span class="line">  %c = alloca i32, align 4</span><br><span class="line">  store i32 5, i32* %a, align 4</span><br><span class="line">  store i32 3, i32* %b, align 4</span><br><span class="line">  %1 = load i32* %a, align 4</span><br><span class="line">  %2 = load i32* %b, align 4</span><br><span class="line">  %3 = mul nsw i32 %1, %2</span><br><span class="line">  store i32 %3, i32* %c, align 4</span><br><span class="line">  %4 = load i32* %c, align 4</span><br><span class="line">  ret i32 %4</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">attributes #0 = &#123; nounwind uwtable &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;no-frame-pointer-elim&quot;=&quot;true&quot; &quot;no-frame-pointer-elim-non-leaf&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span><br><span class="line"></span><br><span class="line">!llvm.ident = !&#123;!0&#125;</span><br><span class="line"></span><br><span class="line">!0 = metadata !&#123;metadata !&quot;clang version 3.4.2 (tags/RELEASE_34/dot2-final)&quot;&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>实现编译器前端</strong></p>
<p>使用自定义的语言TOY，为其编写词法分析器和语法分析器，以及使用前端从抽象语法树生成IR代码。</p>
<blockquote>
<p>定义TOY语言</p>
</blockquote>
<p>实现词法分析器和语法分析器之前，先需要定义这门语言的语法。</p>
<p>一门编程语言会有一些变量、函数调用、常量等。TOY语言只包含32位的整型常量类型，以及不需要声明类型的变量。</p>
<p>语法通过如下的推导规则来定义：非终结符号在左边，终结符号和非终结符的组合在右边；当遇到一个LHS，就会根据推导规则生成与之对应的RHS。</p>
<p>一个算术表达式可以是一个数字常量：numeric_expr := number</p>
<p>括号表达式会在左右括号之间包含一个表达式：paran_expr := ‘(‘ expression ‘)’</p>
<hr>
<p>Reference：</p>
<ol>
<li><a href="">LLVM Cookbook</a></li>
</ol>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>